---
layout: default
title: ""
---
<div class="column-1"><div class="column-1-content">
                            
                                
                                    

<p>&nbsp;<img alt="SnPM_Central" border="0" src="../../img/snpm8/snpm_central.gif"></p>

<h2 align="center">SnPM</h2>

<hr width="80%" size="4"> <!-- 
<H1 ALIGN=CENTER>Statistical nonParametric Mapping</H1>
<HR SIZE="4" WIDTH="80%">
-->

<h2 align="center">A Worked fMRI Example <img border="0" src="../../img/snpm8/new.gif"></h2>

<p><br clear="all">
   </p>

<p align="center"><em>SnPM is an SPM toolbox developed by Andrew Holmes &amp; Tom Nichols</em> </p>

<p>&nbsp;</p>

<h3 align="center"><a></a></h3>

<!-- U N D E R - C O N S T R U C T I O N  m t i   a p n &lt; H > &lt; R S Z = 4   I T = 8 % >     -->
<!-- <TABLE border=7 width="60%" cellspacing=0 cellpadding=0><TR valign="middle"><TD align="center" bgcolor="gray"><img src="../Construction.gif" _mce_src="../Construction.gif" ALIGN=center WIDTH=38 HEIGHT=38 BORDER=0 HSPACE=2 ALT="[Men@Work]"></TD><TD align="center"><font color="gray"><em>This area is under construction</em></font></TD><TD align="center" bgcolor="gray"><img src="../Construction.gif" _mce_src="../Construction.gif" ALIGN=center WIDTH=38 HEIGHT=38 BORDER=0 HSPACE=2 ALT="[Men@Work]"></TD></TR></TABLE><BR> -->
<!--  C N E > T B E b r e =   i t = 6 %   e l p c n =   e l a d n = > T   a i n " i d e > T   l g = c n e " b c l r " r y > i g s c " .-->
<hr> 
<p><br>
   <a name="top"></a></p>

<!--=================================================================-->
<!-- N A V I G A T I O N - S I D E B A R - & - I N T R O  = = = = = = T   a i n "-->
<table cellspacing="0" cols="2" cellpadding="0" width="100%" border="0" style="max-width: none;">
  <tbody>
    <tr>
      <td valign="top" align="center" width="15%" bgcolor="#afafaf"><br>
         <em>This page...</em>         <hr width="60%"> <a href="#intro">introduction</a>         <hr width="60%"> <a href="#thedata">example data</a>         <hr width="60%"> <a href="#exchngNperms">background</a>         <hr width="60%"> <a href="#setup">design setup</a>         <hr width="60%"> <a href="#compute">computation</a>         <hr width="60%"> <a href="#results">viewing results</a>         <hr width="60%"> <br>
         <em>SnPM pages...</em>         <hr width="60%"> <a href="http://www2.warwick.ac.uk/fac/sci/statistics/staff/research/nichols/software/snpm/">SnPM</a>         <hr width="60%"> <a href="http://www2.warwick.ac.uk/fac/sci/statistics/staff/research/nichols/software/snpm/man">manual</a>         <hr width="60%"> <a href="http://www2.warwick.ac.uk/fac/sci/statistics/staff/research/nichols/software/snpm/ex">PET example</a>         <hr width="60%"> <a href="exnew.html"></a><strong>fMRI example</strong>         <hr width="60%"> <a href="http://www2.warwick.ac.uk/fac/sci/statistics/staff/research/nichols/software/snpm/fsl">FSL users</a>         <hr width="60%"> </td>
      <td valign="top" width="3%">&nbsp;</td>
      <td valign="top" width="82%"><!--                                                      = = = = = = T   a i n " i d e > T   l g = c n e " b c l r " r y > i g s c " .-->

        <h2><a name="intro">New SnPM example</a> </h2>

 In this section, we analyze multi-subject event-related fMRI data with the SnPM software. <!-- Do we need the following part? -->
 The aim of this example is:         <ol type="i">
          <li>Give another example to demonstrate the steps of an SnPM analysis by analyzing the fMRI data. <!--
  <LI> Explain and illustrate the key role of exchangeability
  <LI> Provide a bench mark analysis for validation of an SnPM installation
-->
</li>
        </ol>

        <p>The same set of data have also been analyzed by SPM. The details can be found at <a href="http://www.fil.ion.ucl.ac.uk/spm/data/#SPM00Multi">SPM website</a> ("fMRI: multi-subject (random effects) analyses - Canonical" data set). </p>

        <p>The reference is: Henson, R.N.A, Shallice, T., Gorno-Tempini, M.-L. &amp; Dolan, R.J (2002). Face repetition effects in implicit and explicit memory tests as measured by fMRI. Cerebral Cortex, 12, 178-186. </p>

        <p>We will give two standard methods to analyze the data by using nonparametric methods: </p>

        <ol type="i">
          <li><a href="#without">Without smoothed variance t</a> </li>
          <li><a href="#with">With Smoothed variance t</a> </li>
        </ol>

        <p>&nbsp;</p>

<!--    L > E p a n a d i l s r t   h   e   o e o   x h n e b l t 
   L > P o i e a b n h m r   n l s s f r v l d t o   f a   n M i s a-->
      </td>
    </tr>
  </tbody>
</table>

<p>&nbsp;</p>

<hr> 
<h2>The Example Data </h2>

<!--    L > E p a n a d i l s r t   h   e   o e o   x h n e b l t 
   L > P o i e a b n h m r   n l s s f r v l d t o   f a   n M i s a-->
<p>The data are from a study on face repetition effects in implicit and explicit memory tests (Henson et al. 2002; see above). </p>

<p>In this study, twelve volunteers (six male; aged 22-42 years, median 29 years) participated in the experiment. Faces of famous and nonfamous people were presented to the subjects for 500 ms, and replaced by a baseline of an oval chequerboard throughout the interstimulus interval. Each subject was scanned during the experiment and his or her fMRI images were obtained. </p>

<p>Each subject's data were analyzed, creating a difference image between faces and chequerboad (baseline) watchings. So each image here is the contrast image for each subject. </p>

<p>Under the null hypothesis we can permute the labels of the effects of interest. One way of implimenting this with contrast images is to randomly change the sign of each subject's contrast. This sign-flipping approach can be justified by a symmetric distribution for each voxel's data under the null hypothesis. While symmetry may sound like a strong assumption, it is weaker than Normality, and can be justified by a subtraction of two sample means with the same (arbitrary) distribution. </p>

<p>Hence the null hypothesis here is:<br>
   H<sub>0</sub>: The symmetric distribution of (the voxel values of the) subjects' contrast images have zero mean. </p>

<hr> 
<h2>Exchangeability of Second Level fMRI Data </h2>

<!--    L > E p a n a d i l s r t   h   e   o e o   x h n e b l t 
   L > P o i e a b n h m r   n l s s f r v l d t o   f a   n M i s a-->
<p>fMRI data presents a special challenge for nonparametric methods. Because fMRI data exhibits temporal autocorrelation, an assumption of exchangeability of scans within subject is not tenable. However, to analyze a group of subjects for population inference, we need to only assume exchangeability of subjects. The conventional assumption of independent subjects implies exchangeability, and hence a single exchangeability block (EB) consisting of all subjects. </p>

<p>(On a technical note, the assumption of exchangeability can actually be relaxed for the one-sample case considered here. A sufficient assumption for the contrast data to have a symmetric distribution, is for each subject's contrast data to have a symmetric but possibly different distribution. Such differences between subjects violates exchangeability of all the data; however, since the null distribution of the statistic of interest is invariant with respect to sign-flipping, the test is valid.) </p>

<p><a name="without"></a></p>

<hr> 
<h2>Nonparametric Analysis</h2>

<h2>(Without smoothed variance t)</h2>

<!--    L > E p a n a d i l s r t   h   e   o e o   x h n e b l t 
   L > P o i e a b n h m r   n l s s f r v l d t o   f a   n M i s a-->
<p>You can implement a nonparametric random effects analysis using the SnPM software which you can download from http://www.fil.ion.ucl.ac.uk/spm/snpm/. </p>

<p>First follow the instructions on the above web page to download and install SnPM (don't forget the patches !). </p>

<p>Then, in matlab (in a new directory !) type </p>

<dl>
  <dd><pre> 
snpm
</pre>
  </dd>
</dl>
<p>SnPM is split up into three components (1) Setup, (2) Compute and (3) Results. </p>

<p><img alt="SnPM Three components Page" border="0" src="../../img/snpm8/v1_snpm_new.gif" style="border: black 1px solid;"></p>

<p>First click on </p>

<p>Setup </p>

<p>Then type in the following options (your responses are in square brackets). Select design type [Multisub: One sample T test on differences; 1 condition] Select all scan files from the corresponding directory in a window as below <br> [con_0006.img -&gt; con_0017.img] <img alt="Select all scans" border="0" src="../../img/snpm8/v1_select_files_new.gif" style="border: black 1px solid;"></p>

<p style="text-align: left;">Number of confounding covariates [0] 4096 Perms. Use approx test ? [No] </p>

<dl></dl>
<p>(typically, with fewer than 5000 Perms your computer should be quick enough to use an exact test - ie. to go through all permutations) </p>

<dl>
  <dd><pre> 
FWHM(mm) for Variance smooth [0]
</pre>
  </dd>
</dl>
<p>See below (and http://www.fil.ion.ucl.ac.uk/spm/snpm/) for more info on the above option. </p>

<dl>
  <dd><pre> 
Collect Supra-Threshold stats [Yes]
 
Define the thresh now? [No]
</pre>
  </dd>
</dl>
<p>Collecting suprathreshold statistics is optional because the file created is huge; it is essentially the "mountain tops" of the statistic image of every permutation is saved. Say "No" if you want to save disk space and time. </p>

<dl>
  <dd><pre> 
Select Global Normalisation [No Global Normalization]
      
Grand Mean Scaling  [No Grand Mean Scaling]
 
</pre>
  </dd>
</dl>
<p>The above option doesn't matter because no normalisation will be done (this is specified in the next step) </p>

<dl>
  <dd><pre> 
Threshold masking [None]
      </pre>
  </dd>
</dl>
<p>Note, there's no need to use threshold masking since the data are already implicitly masked with NaN's. </p>

<p style="text-align: left;">Finally, the Setup Menu is as below: </p> <br><br>

<p><img height="410" alt="Setup Menu" width="392" border="0" src="../../img/snpm8/v1_setup_page_new.gif" style="border: black 1px solid;"></p>

<p>SnPM will now create the file SnPMcfg.mat. and show the Design Matrix in the Graphics window. </p>

<p>Now click on </p>

<dl>
  <dd><pre> 
Compute
</pre>
  </dd>
</dl>
<p>Select the file (SnPMcfg.mat) as below <img alt="Choose the file to compute" border="0" src="../../img/snpm8/v1_compute_new.gif" style="border: black 1px solid;"></p>

<p>The computation should take between 5 and 10 minutes depending on your computer.In one of the SnPM window, it will show the percentage of the completeness, and in the matlab window, the permutation step that is being performed will be listed. </p>

<p><a name="NoSm_CompListing"><img alt="Computing Process" border="0" src="../../img/snpm8/compute_demo2.gif" style="border: black 1px solid;"></a></p>

<p>Note that it shows how many minutes and seconds spent on each permutation. The number in parentheses is the percentage of time spent on variance smoothing. Since we choose no variance smoothing, this is 0%. </p>

<p>Finally click on </p>

<dl>
  <dd><pre> 
Results
</pre>
  </dd>
</dl>
<p>Select the SnPM.mat file in the corresponding directory as below, <img alt="select SnPM.mat" border="0" src="../../img/snpm8/v1_results_select_new.gif" style="border: black 1px solid;"></p>

<p>In the menu, choose the following options: </p>

<dl>
  <dd><pre> 
 
 
Positive or negative effects?: (+ve)<br> 
Write filtered statistic img?: (yes)<br> 
Filename?: SnPMt_filtered <br> 
Results for which img? (T)<br> 
Voxelwise: Use Corrected thresh (FWE) <br> 
FWE-Corrected p value threshold: (0.05)<br> 
 
</pre>
  </dd>
</dl>
<p>Finally, the SnPM PostProcess menu will be as below, <img height="410" alt="SnPM postprocess menu" width="391" border="0" src="../../img/snpm8/v1_results_menu_new.gif" style="border: black 1px solid;"></p>

<p>SnPM will then show the distribution of the maximum t-statistic. </p>

<p><img alt="Results: permutation distributions" border="0" src="../../img/snpm8/permutation_distributions.gif" style="border: black 1px solid;"></p>

<p>A small dialog box will come out and ask you to review the permutation distributions and to choose either 'Print &amp; Continue' (to print the histogram to spm_date.ps file and then to continue) or just 'Continute' only. Click on one of the two buttons. </p>

<p>On next page, SnPM will then show the permutation distributions of the uncorrected P values, together with a FDR plot. </p>

<p><img height="858" alt="Results: Uncorrected P Permutation Distributions and FDR Plot" width="604" border="0" src="../../img/snpm8/uncorrected_P_hist.gif" style="border: black 1px solid;"></p>

<p>Choose to print the page to spm_date.ps file and then continue or to continue directly by using the prompted small dialog box. <br>
   On next page, SnPM will then plot a MIP of those voxels surviving the SnPM critical threshold (this value is displayed at the bottom of the image and for this data set should be 7.92). </p>

<p><img height="860" alt="Results: MIP and et.c." width="614" border="0" src="../../img/snpm8/results_MIP.gif" style="border: black 1px solid;"></p>

<p>You can then use this value in SPM (in the RESULTS section, say 'No' to corrected height threshold, and then type in 7.9248 for the threshold) and take advantage of SPMs rendering routines (not available in SnPM). </p>

<p>Note that the SnPM threshold is lower than the SPM threshold (9.07). Consequently, SnPM shows more active voxels. </p>

<p align="right"><a href="#top">...to top</a> </p>

<p>&nbsp;</p>

<p><a name="with"></a></p>

<hr> 
<h2>Nonparametric Analysis</h2>

<h2>(With smoothed variance t, Pseudo-t)</h2>

<p>Note that the result just obtained looks "jaggedy". That is, while the image data is smooth (check the con* images), the t statistic image is rough. A t statistic is a estimate divided by a square root of the variance of the estimate, and this roughness is due to uncertainty of the variance estimate; this uncertainty is especially bad when the degrees of freedom are low (here, 11). By smoothing the variance before creating a t ratio we can eliminate this roughness and effectively increase our degrees of freedom, increasing our power. </p>

<p>Create a new directory for the smoothed variance results. </p>

<p>First click on </p>

<dl>
  <dd><pre> 
Setup
</pre>
  </dd>
</dl>
<p>Then type in the following options (your responses are in square brackets). </p>

<dl>
  <dd><pre> 
[Multisub: One Sample T test on differences; 1 condition]<br> 
Select all scans [con_0006.img -&gt; con_0017.img]<br> 
Number of confounding covariates [0]<br> 
4096 Perms. Use approx test ?   [No]  <br> 
FWHM(mm) for Variance smooth [8]<br> 
 
</pre>
  </dd>
</dl>
<p>A rule of thumb for the variance smoothing is to use the same FWHM that was applied to the data (which is what we've used here), though a little as 2 x VoxelSize may be sufficient. </p>

<dl>
  <dd><pre> 
Collect Supra-Threshold stats [Yes]<br> 
Select Global Normalisation [No Global Normalization]<br> 
Define the thresh now? [No] <br> 
Grand Mean Scaling [No Grand Mean Scaling] <br> 
 
</pre>
  </dd>
</dl>
<p>Again, this doesn't matter because no normalisation will be done. </p>

<dl>
  <dd><pre> 
Threshold masking [None]<br> 
 
 
</pre>
  </dd>
</dl>
<p>The final Setup Menu will be as below,<br> <img alt="Setup Menu" border="0" src="../../img/snpm8/v1_setup_page_new_2.gif" style="border: black 1px solid;"></p>

<p>SnPM will now create the file SnPMcfg.mat. In the Graphics window, the design matrix will be shown. </p>

<p>Now click on </p>

<dl>
  <dd><pre> 
Compute
</pre>
  </dd>
</dl>
<p>Select the file (SnPMcfg.mat) </p>

<p>In the matlab window, the permutation step that is being performed will be listed. </p>

<p><img alt="Computing Process" border="0" src="../../img/snpm8/compute_perm.gif" style="border: black 1px solid;"></p>

<p>Note that it shows how many minutes and seconds spent on each permutation. The number in parentheses is the percentage of time spent on variance smoothing. Compare this result with what we get from <a href="#NoSm_CompListing">"Without smoothed variance t" method</a> (0% in that case). </p>

<p>The above computation should take between 10 and 25 minutes depending on your computer. </p>

<p>Finally click on </p>

<dl>
  <dd><pre> 
Results
</pre>
  </dd>
</dl>
<p>Select the SnPM.mat file </p>

<p>Make the following choices: </p>

<dl>
  <dd><pre> 
 
Positive or negative effects?: (+ve)<br> 
Write filtered statistic img?: (yes)<br> 
Filename?: SnPMt_filtered<br> 
Results for which img? (T) <br> 
Write FWE-corrected p-value img?: (yes)<br> 
Use corrected threshold?: (FWE)<br> 
Voxelwise FWE-Corrected p value threshold: (0.05)<br> 
 
 
</pre>
  </dd>
</dl>
<p>The final Results Setup Menu will be as below, <br><img alt="Setup Menu" border="0" src="../../img/snpm8/v1_results_menu_new.gif" style="border: black 1px solid;"></p>

<p>SnPM will then show the distribution of the maximum *pseudo* t-statistic, or smoothed variance t statistic as below. </p>

<p><img alt="Setup Menu" border="0" src="../../img/snpm8/results_distribution.gif" style="border: black 1px solid;"></p>

<p>A small dialog box will come out and ask you to review the permutation distributions and to choose either 'Print &amp; Continue' (to print the histogram to spm_date.ps file and then to continue) or just 'Continute' only. Click on one of the two buttons. </p>

<p>On next page, SnPM will then show the permutation distributions of the uncorrected P values, together with a FDR plot. </p>

<p><img alt="Results: Uncorrected P Permutation Distributions and FDR Plot" border="0" src="../../img/snpm8/uncorrected_P_hist.gif" style="border: black 1px solid;"></p>

<p>Choose to print the page to spm_date.ps file and then continue or to continue directly by using the prompted small dialog box. <br>
   On next page, SnPM will then plot a MIP of those voxels surviving the SnPM critical threshold (this value is displayed at the bottom of the image and for this data set should be 5.33). </p>

<p><img alt="Setup Menu" border="0" src="../../img/snpm8/results_MIP_2.gif" style="border: black 1px solid;"></p>

<p>Observe how there are both more suprathreshold voxels, and that the image is smoother. For example, note that the anterior cingulate activation (3,15,45) is now 356 voxels, as compared with 75 with SnPM{t} or 28 with SPM{t}. </p>

<p>Very important!!! This is <em>not</em> a t image. So you <em>cannot</em> apply this threshold to a t image in SPM. You can, however, create overlay images with the following: </p>

<ol>
  <li>Use 'Display' to select the image you would like for a background. Via the keyboard only you could do... 
    <dl>
      <dd><pre> 
Img =  spm_get(1,'.img','select background reference');
spm_image('init',Img)</pre>
        <p>&nbsp;</p>

      </dd>
    </dl>
  </li>
  <li>Create filtered image with NaN's instead of zero's. 
    <dl>
      <dd><pre> 
In    = 'SnPMt_filtered';
Out   = 'SnPMt_filteredNaN';
f     = 'i1.*(i1./i1)';
flags = {0,0,spm_type('float')};
spm_imcalc_ui(In,Out,f,flags);
</pre>
      </dd>
    </dl>
 Ignore the division by zero errors.     <p>&nbsp;</p>

  </li>
  <li>Overlay the filtered image 
    <dl>
      <dd> 
        <kbd>spm_orthviews('addimage',1,'SnPMt_filteredNaN')</kbd>
        <p>&nbsp;</p>

      </dd>
    </dl>
  </li>
</ol>

<p align="right"><a href="#top">...to top</a> </p>

<p>&nbsp;</p>

<hr> 
<ul>
  <li>Back to <a>main SnPM page</a> <!--=================================================================-->
    <hr> </li>
  <li> 
    <address><!--=================================================================-->
<em>SnPM</em> by <a href="http://www.fil.ion.ucl.ac.uk/~andrew">Andrew Holmes</a> of the <a>Astra Zeneca</a><br>
       &amp; <a href="http://www.sph.umich.edu/~nichols">Tom Nichols</a> of <a hrerf="http://www.sph.umich.edu/biostat">University of Michigan Biostatistics department</a> </address>
  </li>
  <li>SnPMauthors at &lt;<a href="mailto:snpm-authors at umich.edu">snpm-authors at umich.edu</a>&gt; <!-- hhmts start -->
 Last modified: Wed Oct 26 15:09:01 EDT 2005 <!-- hhmts end -->
    <address></address>
  </li>
</ul>



                                
                                
                            
                        </div></div>